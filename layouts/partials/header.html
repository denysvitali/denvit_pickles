<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode }}" prefix="og: http://ogp.me/ns#">
{{ partial "head.html" . }}
<body>
  <a href="#main" class="skip-link p-screen-reader-text">{{ i18n "skip-to-content" }}</a>
  {{ partial "svgpack-sprite.html" . }}
  <header class="l-header">
    <div class="l-header-inner">
      {{ if .IsPage }}
      <p class="c-title p-title"><a href="{{ .Site.BaseURL }}" class="p-title__link">{{ .Site.Title }}</a></p>
      {{ else }}
      <h1 class="c-title p-title"><a href="{{ .Site.BaseURL }}" class="p-title__link">{{ .Site.Title }}</a></h1>
      {{ end }}
      {{ with ($.Param "subtitle") }}
      <p class="p-subtitle">
        {{ . }}
      </p>
      {{ end }}

      <div class="l-nav-wrapper">
        <button class="mobile-menu-toggle" aria-expanded="false" aria-label="Toggle navigation">
          <span></span>
          <span></span>
          <span></span>
        </button>
        {{- partial "menu.html" . -}}
        <button class="search-toggle" aria-label="Search" aria-expanded="false">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="M21 21l-4.35-4.35"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>
  {{- partial "header_custom.html" . }}

  <!-- Full-screen mobile menu overlay -->
  <div class="mobile-menu-overlay" id="mobile-menu-overlay" hidden>
    <div class="mobile-menu-header">
      <a href="{{ .Site.BaseURL }}" class="mobile-menu-logo">/dev/random</a>
      <button class="mobile-menu-close" aria-label="Close menu" id="mobile-menu-close">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div class="mobile-menu-content">
      {{- partial "menu.html" . -}}
    </div>
  </div>

  <!-- Search container -->
  <div class="search-container" id="search-container" hidden>
    {{- partial "search.html" . -}}
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    var toggle = document.querySelector('.mobile-menu-toggle');
    var navWrapper = document.querySelector('.l-nav-wrapper');
    var overlay = document.getElementById('mobile-menu-overlay');
    var closeBtn = document.getElementById('mobile-menu-close');
    var searchToggle = document.querySelector('.search-toggle');
    var searchContainer = document.getElementById('search-container');

    // Menu toggle
    if (toggle && overlay) {
      toggle.addEventListener('click', function() {
        var isExpanded = toggle.getAttribute('aria-expanded') === 'true';
        if (isExpanded) {
          // Close menu
          toggle.setAttribute('aria-expanded', 'false');
          overlay.hidden = true;
          overlay.classList.remove('is-open');
          document.body.classList.remove('has-open-menu');
        } else {
          // Open menu
          toggle.setAttribute('aria-expanded', 'true');
          overlay.hidden = false;
          document.body.classList.add('has-open-menu');
          // Small delay to allow display:flex to apply before opacity transition
          requestAnimationFrame(function() {
            overlay.classList.add('is-open');
          });
        }
      });
    }

    // Close button
    if (closeBtn && overlay && toggle) {
      closeBtn.addEventListener('click', function() {
        toggle.setAttribute('aria-expanded', 'false');
        overlay.classList.remove('is-open');
        document.body.classList.remove('has-open-menu');
        setTimeout(function() {
          overlay.hidden = true;
        }, 300);
      });
    }

    // Close menu when clicking a link
    if (overlay) {
      var menuLinks = overlay.querySelectorAll('a');
      menuLinks.forEach(function(link) {
        link.addEventListener('click', function() {
          if (toggle && overlay) {
            toggle.setAttribute('aria-expanded', 'false');
            overlay.classList.remove('is-open');
            document.body.classList.remove('has-open-menu');
            setTimeout(function() {
              overlay.hidden = true;
            }, 300);
          }
        });
      });
    }

    // Search toggle
    if (searchToggle && searchContainer) {
      searchToggle.addEventListener('click', function() {
        var isHidden = searchContainer.hidden;
        searchContainer.hidden = !isHidden;
        searchToggle.setAttribute('aria-expanded', isHidden);
        if (isHidden && searchContainer.querySelector('#search')) {
          var input = searchContainer.querySelector('.pagefind-ui__search-input');
          if (input) {
            setTimeout(function() { input.focus(); }, 100);
          }
        }
      });
    }
  });
  </script>
  <main id="main" class="l-main{{ if not .IsPage }} l-main--list{{ end }}">
  {{ if .IsPage }}
  <aside class="tableOfContentContainer" id="tableOfContentContainer">
    <h3>Table of contents</h3>
    {{ .TableOfContents }}
  </aside>
  <script>
  (function() {
    function initScrollSpy() {
      // Active heading highlighting via scroll spy
      var tocContainer = document.getElementById('tableOfContentContainer');
      if (!tocContainer) {
        return;
      }

      var headingSelectors = '#js-article h1, #js-article h2, #js-article h3, #js-article h4';
      var headings = document.querySelectorAll(headingSelectors);
      var tocLinks = tocContainer.querySelectorAll('a');


      if (headings.length === 0 || tocLinks.length === 0) return;

      // Create a map of heading IDs to links
      var headingIdToLink = {};
      headings.forEach(function(heading) {
        var id = heading.id;
        if (id) {
          var link = tocContainer.querySelector('a[href="#' + id + '"]');
          if (link) {
            headingIdToLink[id] = link;
          }
        }
      });


      function updateActiveHeading() {
        var scrollY = window.scrollY;
        var scrollMargin = 72;

        var activeId = null;
        var maxOffset = -Infinity;

        headings.forEach(function(heading) {
          var id = heading.id;
          if (!id || !headingIdToLink[id]) return;

          // Get heading's offset from document top, minus scroll margin
          var headingOffset = heading.offsetTop - scrollMargin;

          // Heading is "passed" if its offset is <= current scroll position
          if (headingOffset <= scrollY && headingOffset > maxOffset) {
            maxOffset = headingOffset;
            activeId = id;
          }
        });

        // Use the first heading's offset as the threshold
        // Don't highlight any heading if we haven't scrolled past the first one
        if (headings.length > 0) {
          var firstHeadingOffset = headings[0].offsetTop - scrollMargin;
          if (scrollY <= firstHeadingOffset) {
            activeId = null;
          }
        }

        // Fallback to the last heading if scrolled past all
        if (!activeId && headings.length > 0 && scrollY > firstHeadingOffset) {
          activeId = headings[headings.length - 1].id;
        }

        // Update active state
        tocLinks.forEach(function(link) {
          link.classList.remove('active');
        });
        if (activeId && headingIdToLink[activeId]) {
          headingIdToLink[activeId].classList.add('active');
        }
      }

      // Run on scroll with throttling
      var ticking = false;
      window.addEventListener('scroll', function() {
        if (!ticking) {
          requestAnimationFrame(function() {
            updateActiveHeading();
            ticking = false;
          });
          ticking = true;
        }
      }, { passive: true });

      // Run on initial load
      updateActiveHeading();
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initScrollSpy);
    } else {
      initScrollSpy();
    }
  })();
  </script>
  {{ end }}
